name: CI

# Ce workflow s'exécute automatiquement à chaque push ou pull request
# sur les branches main et develop
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  # ============================================
  # JOB : Tests Backend (Nest.js)
  # ============================================
  backend:
    name: Backend (NestJS + Prisma)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
      # Étape 1 : Récupérer le code
      - uses: actions/checkout@v4

      # Étape 2 : Installer Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: 20  # Version LTS utilisée dans Docker
          cache: npm
          cache-dependency-path: backend/package-lock.json

      # Étape 3 : Installer les dépendances
      - run: npm ci

      # Étape 4 : Générer le client Prisma (nécessite DATABASE_URL)
      - name: Générer Prisma Client
        run: npx prisma generate
        env:
          # URL de test pour Prisma CI/CD uniquement (pas de vraies credentials en production)
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'mysql://test:test@localhost:3306/test_db' }}

      # Étape 5 : Compiler le code TypeScript
      - run: npm run build

      # Étape 6 : Vérifier les types TypeScript
      - run: npx tsc -p tsconfig.json --noEmit

      # Étape 7 : Exécuter les tests (si vous en avez)
      # - run: npm test

  # ============================================
  # JOB : Tests Frontend (Symfony)
  # ============================================
  frontend:
    name: Frontend (Symfony)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    steps:
      # Étape 1 : Récupérer le code
      - uses: actions/checkout@v4

      # Étape 2 : Installer PHP
      - name: Installer PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pdo_mysql, intl, zip
          coverage: none

      # Étape 3 : Créer le fichier .env minimal pour Symfony
      - name: Créer le fichier .env
        run: |
          cd frontend
          cat > .env << 'EOF'
          APP_ENV=test
          APP_DEBUG=false
          APP_SECRET=test-secret-key-for-ci-cd-only-not-for-production-use-32-chars
          # URL de test pour CI/CD uniquement (pas de vraies credentials)
          DATABASE_URL=mysql://test:test@localhost:3306/test_db
          DEFAULT_URI=http://localhost
          EOF

      # Étape 4 : Installer Composer
      - name: Installer Composer
        uses: php-actions/composer@v6
        with:
          working_dir: frontend

      # Étape 5 : Installer les dépendances (sans scripts pour éviter cache:clear)
      - name: Installer les dépendances Composer
        run: composer install --no-interaction --prefer-dist --no-scripts

      # Étape 6 : Vider le cache manuellement avec les variables d'environnement
      - name: Vider le cache Symfony
        run: |
          cd frontend
          APP_ENV=test APP_SECRET=test-secret-key-for-ci-cd-only-not-for-production-use-32-chars DEFAULT_URI=http://localhost php bin/console cache:clear --no-warmup || true

      # Étape 7 : Vérifier la syntaxe PHP
      - name: Vérifier la syntaxe PHP
        run: find . -name "*.php" -exec php -l {} \;

      # Étape 8 : Exécuter les tests (si vous en avez)
      # - run: php bin/phpunit
