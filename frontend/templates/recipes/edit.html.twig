{% extends 'layouts/app.html.twig' %}

{% block page_title %}Modifier la recette{% endblock %}

{% block content %}
    <div class="space-y-6">
        <div class="bg-white rounded-xl shadow-sm p-8">
            <h2 class="text-2xl font-bold text-dark-blue mb-6">Modifier la recette</h2>
            
            {# Messages flash #}
            {% for message in app.flashes('success') %}
                <div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                    {{ message }}
                </div>
            {% endfor %}
            
            {% for message in app.flashes('error') %}
                <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                    {{ message }}
                </div>
            {% endfor %}
            
            {# Formulaire #}
            {{ form_start(form, {'attr': {'class': 'space-y-6'}}) }}
            
                <div>
                    {{ form_label(form.titre, null, {'label_attr': {'class': 'block text-sm font-semibold text-dark-blue mb-2'}}) }}
                    {{ form_widget(form.titre) }}
                    {{ form_errors(form.titre) }}
                </div>
                
                <div>
                    {{ form_label(form.description, null, {'label_attr': {'class': 'block text-sm font-semibold text-dark-blue mb-2'}}) }}
                    {{ form_widget(form.description) }}
                    {{ form_errors(form.description) }}
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        {{ form_label(form.temps_preparation, null, {'label_attr': {'class': 'block text-sm font-semibold text-dark-blue mb-2'}}) }}
                        {{ form_widget(form.temps_preparation) }}
                        {{ form_errors(form.temps_preparation) }}
                    </div>
                    
                    <div>
                        {{ form_label(form.image_url, null, {'label_attr': {'class': 'block text-sm font-semibold text-dark-blue mb-2'}}) }}
                        {{ form_widget(form.image_url) }}
                        {{ form_errors(form.image_url) }}
                    </div>
                </div>
                
                <div class="flex items-center">
                    {{ form_widget(form.is_favorite) }}
                    {{ form_label(form.is_favorite, null, {'label_attr': {'class': 'ml-2 text-sm font-semibold text-dark-blue'}}) }}
                    {{ form_errors(form.is_favorite) }}
                </div>
                
                {# Section Ingrédients #}
                <div class="pt-6 border-t border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <label class="block text-sm font-semibold text-dark-blue">Ingrédients</label>
                        <button type="button" id="add-ingredient-btn" class="bg-primary-green text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-primary-green/90 transition-colors">
                            + Ajouter un ingrédient
                        </button>
                    </div>
                    
                    <div id="ingredients-list" class="space-y-4">
                        {% for ingredient in form.ingredients %}
                            <div class="ingredient-item bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        {{ form_label(ingredient.ingredient_id, null, {'label_attr': {'class': 'block text-sm font-semibold text-dark-blue mb-2'}}) }}
                                        {{ form_widget(ingredient.ingredient_id) }}
                                        {{ form_errors(ingredient.ingredient_id) }}
                                    </div>
                                    <div>
                                        {{ form_label(ingredient.quantite, null, {'label_attr': {'class': 'block text-sm font-semibold text-dark-blue mb-2'}}) }}
                                        {{ form_widget(ingredient.quantite) }}
                                        {{ form_errors(ingredient.quantite) }}
                                    </div>
                                </div>
                                <button type="button" class="mt-2 text-red-600 hover:text-red-800 text-sm font-semibold remove-ingredient-btn">
                                    Supprimer
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                    
                    {# Prototype pour les nouveaux ingrédients #}
                    <div id="ingredient-prototype" data-prototype="{{ form_widget(form.ingredients.vars.prototype)|e('html_attr') }}" style="display: none;"></div>
                    
                    {{ form_errors(form.ingredients) }}
                </div>
                
                <div class="pt-4 flex gap-4">
                    {{ form_widget(form.submit) }}
                    <a href="{{ path('app_recipes') }}" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors text-center">
                        Annuler
                    </a>
                </div>
            
            {{ form_end(form) }}
        </div>
    </div>
    
    {# JavaScript pour gérer les ingrédients dynamiquement #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addBtn = document.getElementById('add-ingredient-btn');
            const ingredientsList = document.getElementById('ingredients-list');
            const prototype = document.getElementById('ingredient-prototype');
            let ingredientIndex = ingredientsList.children.length;
            
            // Fonction pour ajouter un ingrédient
            function addIngredient() {
                const prototypeHtml = prototype.dataset.prototype;
                const newForm = prototypeHtml.replace(/__name__/g, ingredientIndex);
                
                const ingredientDiv = document.createElement('div');
                ingredientDiv.className = 'ingredient-item bg-gray-50 p-4 rounded-lg border border-gray-200';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                contentDiv.innerHTML = newForm;
                
                // Ajouter les labels et styles
                const selects = contentDiv.querySelectorAll('select');
                const inputs = contentDiv.querySelectorAll('input');
                
                selects.forEach((select, index) => {
                    select.className = 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent';
                    const label = document.createElement('label');
                    label.className = 'block text-sm font-semibold text-dark-blue mb-2';
                    label.textContent = index === 0 ? 'Ingrédient' : 'Quantité';
                    select.parentNode.insertBefore(label, select);
                });
                
                inputs.forEach(input => {
                    input.className = 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent';
                    if (input.type === 'text' && !input.previousElementSibling || (input.previousElementSibling && input.previousElementSibling.tagName !== 'LABEL')) {
                        const label = document.createElement('label');
                        label.className = 'block text-sm font-semibold text-dark-blue mb-2';
                        label.textContent = 'Quantité';
                        input.parentNode.insertBefore(label, input);
                    }
                });
                
                ingredientDiv.appendChild(contentDiv);
                
                // Ajouter le bouton de suppression
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'mt-2 text-red-600 hover:text-red-800 text-sm font-semibold remove-ingredient-btn';
                removeBtn.textContent = 'Supprimer';
                removeBtn.addEventListener('click', function() {
                    ingredientDiv.remove();
                });
                ingredientDiv.appendChild(removeBtn);
                
                ingredientsList.appendChild(ingredientDiv);
                ingredientIndex++;
            }
            
            // Événement pour ajouter un ingrédient
            if (addBtn) {
                addBtn.addEventListener('click', addIngredient);
            }
            
            // Gestion des boutons de suppression existants
            document.querySelectorAll('.remove-ingredient-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.ingredient-item').remove();
                });
            });
        });
    </script>
{% endblock %}
